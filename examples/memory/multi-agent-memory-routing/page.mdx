import { generateMetadata } from '@/lib/generate-metadata';
import { LanguageProvider, SimpleLanguageToggle, LanguageContent } from '@/components/LanguageToggle';
export const metadata = generateMetadata({
    title: 'Multi-Agent Routing',
    description: `An example of how to use multi-agent routing.`,
    section: 'Examples',
    slug: '/examples/memory/multi-agent-memory-routing'
});

# Multi-Agent Routing

This example demonstrates how to implement intelligent routing between memory and non-memory agents based on query context.

<LanguageProvider defaultLanguage='typescript'>

<RunExample api="/docs/api/memory"

	title="Multi-Agent Routing Example"
	output={`{
  "routerAgentResponse": {
    "useMemory": false
  },
  "memoryAgentResponse": {
    "response": "AI is a field of computer science that focuses on creating intelligent machines that can perform tasks that typically require human intelligence, such as visual perception, speech recognition, decision-making, and language understanding."
  }
}`}
explanation={`
### Components
- **Router Agent**: Analyzes queries to determine if memory context is needed
- **Memory Agent**: Handles AI/ML related queries with context
- **Non-Memory Agent**: Handles general queries

This code illustrates the multi-agent routing using Langbase. Here's a step-by-step guide:

1. Query Analysis:
   - The router agent analyzes the query to determine if it requires memory context.
   - It uses a predefined model to decide whether to route the query to the memory agent.

2. Execution:
   - If the query requires memory context, it is routed to the memory agent.
   - The memory agent processes the query and provides a context-aware response.
   - If the query does not require memory context, it is handled by the non-memory agent.
	`}
>


<LanguageContent language="typescript">
<CodeGroup title="Multi-Agent Routing Example" exampleTitle="Multi-Agent Routing Example">
```ts {{ title: 'index.ts' }}
import dotenv from "dotenv";
import { Langbase } from 'langbase';

dotenv.config();

// Initialize Langbase with your API key
const langbase = new Langbase({
  apiKey: process.env.LANGBASE_API_KEY!
});

// Router agent checks whether or not to use memory agent.
async function runRouterAgent(query) {
  const response = await langbase.pipes.run({
    stream: false,
    name: 'router-agent',
    model: 'openai:gpt-4o-mini', // Ensure this model supports JSON mode
    messages: [
      {
        role: 'system', // Update the content with your memory description
        content: `You are an expert query analyzer. Given a query, analyze whether it needs to use the memory agent or not.
                  The memory agent contains a knowledge base that provides context-aware responses about AI, machine learning,
                  and related topics. If the query is related to these topics, indicate that the memory agent should be used.
                  Otherwise, indicate that it should not be used.
                  Always respond in JSON format with the following structure: {"useMemory": true/false}.`
      },
      { role: 'user', content: query }
    ]
  });

  // Parse the response to determine if we should use the memory agent
  const parsedResponse = JSON.parse(response.completion);
  return parsedResponse.useMemory;
}

// Example usage
async function main() {
  const query = 'What is AI?';
  const useMemory = await runRouterAgent(query);
  console.log('Use Memory:', useMemory);

  if (useMemory) {
    // Run the memory agent
    const response = await langbase.pipes.run({
      stream: false,
      name: 'memory-agent', // Name of your memory agent
      messages: [
        { role: 'user', content: query }
      ]
    });
    console.log('Response from memory agent:', response);
  } else {
    // Run the non-memory agent
    const response = await langbase.pipes.run({
      stream: false,
      name: 'non-memory-agent', // Name of your non-memory agent
      messages: [
        { role: 'user', content: query }
      ]
    });
    console.log('Response from non-memory agent:', response);
  }
}

main();
```
</CodeGroup>
</LanguageContent>

<LanguageContent language="python">
<CodeGroup title="Multi-Agent Routing Example" exampleTitle="Multi-Agent Routing Example">
```python {{ title: 'index.py' }}
import json
import os
from dotenv import load_dotenv
from langbase import Langbase

def main():
    load_dotenv()

    # Get API keys from environment variables
    langbase_api_key = os.getenv("LANGBASE_API_KEY")
    llm_api_key = os.getenv("LLM_API_KEY")

    if not langbase_api_key:
        print("‚ùå Missing LANGBASE_API_KEY in environment variables.")
        return

    if not llm_api_key:
        print("‚ùå Missing LLM_API_KEY in environment variables.")
        return

    # Initialize the client
    langbase = Langbase(api_key=langbase_api_key)

    query = 'What is Langbase?'
    
    # Step 1: Run router agent to determine if memory should be used
    use_memory = run_router_agent(langbase, llm_api_key, query)
    print(f'Use Memory: {use_memory}')

    if use_memory:
        # Run agent with memory retrieval
        run_agent_with_memory(langbase, llm_api_key, query)
    else:
        # Run agent without memory
        run_agent_without_memory(langbase, llm_api_key, query)


def run_router_agent(langbase, llm_api_key, query):
    """Router agent checks whether or not to use memory agent."""
    try:
        response = langbase.agent.run(
            model='openai:gpt-4o-mini',
            api_key=llm_api_key,
            instructions='''You are an expert query analyzer. Given a query, analyze whether it needs to use memory/knowledge base or not.
                           If the query is about AI, machine learning, programming, or technical topics, respond with "true".
                           For general conversation, greetings, or simple questions, respond with "false".
                           Respond with only "true" or "false".''',
            input=[{'role': 'user', 'content': query}]
        )

        # Parse the response to determine if we should use memory
        output = response.get('output', '').strip().lower()
        return output == 'true'
    
    except Exception as e:
        print(f"Error running router agent: {e}")
        return False  # Default to not using memory on error


def run_agent_with_memory(langbase, llm_api_key, query):
    """Run agent with memory retrieval."""
    try:
        # Step 1: Try to retrieve relevant memory (if memory exists)
        memory_context = ""
        try:
            memory_response = langbase.memories.retrieve(
                query=query,
                memory=[{"name": "memory-sdk"}],  # Replace with your memory name
                top_k=3
            )
            if memory_response:
                memory_context = f"\n\nRelevant context from knowledge base:\n{json.dumps(memory_response, indent=2)}"
        except Exception as memory_error:
            print(f"Note: No memory found or memory error: {memory_error}")
            memory_context = ""

        # Step 2: Run agent with memory context
        response = langbase.agent.run(
            model='openai:gpt-4o-mini',
            api_key=llm_api_key,
            instructions='You are an AI expert assistant. Use the provided context to give comprehensive answers about AI and technical topics.',
            input=[{
                'role': 'user', 
                'content': f"{query}{memory_context}"
            }]
        )
        
        print('\nüß† Response from memory-enhanced agent:')
        print(response.get('output', 'No output received'))
        
    except Exception as e:
        print(f"Error running memory agent: {e}")


def run_agent_without_memory(langbase, llm_api_key, query):
    """Run agent without memory."""
    try:
        response = langbase.agent.run(
            model='openai:gpt-4o-mini',
            api_key=llm_api_key,
            instructions='You are a helpful assistant. Provide clear and concise answers.',
            input=[{'role': 'user', 'content': query}]
        )
        
        print('\nüí¨ Response from standard agent:')
        print(response.get('output', 'No output received'))
        
    except Exception as e:
        print(f"Error running standard agent: {e}")


if __name__ == "__main__":
    main()
```
</CodeGroup>
</LanguageContent>

</RunExample>
</LanguageProvider>
